# Core scverse libraries
import scanpy as sc
import anndata as ad
import matplotlib.pyplot as plt

sc.settings.set_figure_params(dpi=50, facecolor="white")

# Load your data
adata = sc.read_h5ad("Liver_facs.h5ad")
adata.var_names_make_unique()
adata.obs_names_make_unique()

# Run Scrublet doublet detection, per sample/batch
sc.pp.scrublet(adata, batch_key="batch")  # or "sample" if you prefer

# Quick look at the added columns
print(adata.obs[['doublet_score', 'predicted_doublet']].head())

import matplotlib.pyplot as plt

# Ensure batch column is categorical
adata.obs['batch'] = adata.obs['batch'].astype('category')

# Check the total number of cells per batch before filtering
original_counts = adata.obs['batch'].value_counts()
print("Original counts per batch (before removing doublets):")
print(original_counts)

# Check number of predicted doublets per batch
doublet_counts = adata.obs.groupby('batch')['predicted_doublet'].sum()
print("\nNumber of predicted doublets per batch:")
print(doublet_counts)

# Remove predicted doublets
adata = adata[~adata.obs['predicted_doublet'], :].copy()

# Verify that remaining cells after removal = original - doublets
remaining_counts = original_counts - doublet_counts
print("\nExpected remaining cells per batch after removing doublets:")
print(remaining_counts)
