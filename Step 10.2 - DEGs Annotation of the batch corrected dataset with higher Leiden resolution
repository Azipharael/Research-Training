import scanpy as sc
import pandas as pd

# --- DEG Validation for BATCH-CORRECTED Annotations ---
# This script uses the data-driven `rank_genes_groups` function to find the
# top genes that define each of the cell types you annotated, including
# the 'mix' clusters, to validate the complete annotation.

# Setup Scanpy settings
sc.settings.verbosity = 3
sc.settings.set_figure_params(dpi=80, facecolor='white', frameon=False)

# 1. Load the AnnData object with your BATCH-CORRECTED cell_type annotations
# This file should be the final output of your previous annotation script.
adata = sc.read_h5ad('Liver_facs_batch_corrected_annotated.h5ad')

# 2. Define the annotation column to use for grouping
# This column contains all your labels, including the mixed ones.
annotation_key = 'cell_type_corrected'

print("Running DEG analysis on the following cell type labels:")
print(adata.obs[annotation_key].value_counts())

# 3. Calculate differentially expressed genes for each annotated cell type
# This wlil compare each cell type against all others. The results for the
# 'mix' clusters will help validate their identity.
sc.tl.rank_genes_groups(adata, groupby=annotation_key, method='t-test')

# 4. Visualize the top marker genes for each cell type
# This plot shows a bar chart of the top genes for every group.
print(f"\nDisplaying top marker genes for each cell type in '{annotation_key}':")
sc.pl.rank_genes_groups(adata, n_genes=20, sharey=False, show=True)

# 5. Create a heatmap of the top marker genes
# A heatmap gives a detailed view of the expression patterns of the
# top defining genes across all your defined cell types.
print(f"\nDisplaying heatmap of top 10 markers per cell type from '{annotation_key}':")
sc.pl.rank_genes_groups_heatmap(adata, n_genes=10, groupby=annotation_key, show=True)

# --- How to Use This Output for Validation ---
#
# Now you can use the output to validate every label you assigned:
#
# 1.  **For your "clean" clusters ('Hepatocyte', 'Kupffer Cell', etc.):**
#     Confirm that the top DEGs found by the algorithm match the canonical
#     markers you expect. This validates your main annotations.
#
# 2.  **For 'Hepatocyte/Cholangiocyte_mix':**
#     Inspect its top genes in the `rank_genes_groups` plot. Do you see a
#     mix of top hepatocyte markers (like 'Alb') and top cholangiocyte
#     markers (like 'Krt19')? If so, this validates your "mix" hypothesis
#     and suggests the cluster likely contains doublets or transitional cells.
#
# 3.  **For 'CD4/CD8/NK_mix':**
#     Similarly, look at its top genes. You should expect to see a combination
#     of pan-T-cell markers ('Cd3d'), specific T-cell markers ('Cd4', 'Cd8a'),
#     and NK cell markers ('Nkg7', 'Gzma'). This confirms that the cluster
#     is an unresolved mix of lymphoid cells.
#
# This approach correctly uses `rank_genes_groups` as a powerful tool to
# investigate and confirm the identity of every single cluster.
#
print("\nScript finished successfully!")
