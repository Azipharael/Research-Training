import scanpy as sc
import pandas as pd

# --- DEG Validation for BATCH-CORRECTED Annotations ---
# This script uses the data-driven `rank_genes_groups` function to find the
# top genes that define each of the cell types you annotated on the
# batch-corrected data. The goal is to validate this new, cleaner annotation.

# Setup Scanpy settings
sc.settings.verbosity = 3
sc.settings.set_figure_params(dpi=80, facecolor='white', frameon=False)

# 1. Load the AnnData object with your BATCH-CORRECTED cell_type annotations
# This file should be the final output of your previous annotation script.
adata = sc.read_h5ad('Liver_facs_batch_corrected_annotated.h5ad')

# 2. Define the new annotation column to use for grouping
# In the previous script, we named this 'cell_type_corrected'.
# If you chose a different name, change this variable.
annotation_key = 'cell_type_corrected'

# 3. Calculate differentially expressed genes for each annotated cell type
# This will compare each cell type against all others to find the genes
# that most uniquely define it in the batch-corrected data.
sc.tl.rank_genes_groups(adata, groupby=annotation_key, method='t-test')

# 4. Visualize the top marker genes for each cell type
# This plot shows a bar chart of the top genes ranked by their score.
# It provides a quick overview to validate your labels.
print(f"Displaying top marker genes for each cell type in '{annotation_key}':")
sc.pl.rank_genes_groups(adata, n_genes=20, sharey=False, show=True)

# 5. Create a heatmap of the top marker genes
# A heatmap gives a detailed view of the expression patterns of the
# top defining genes across all your newly defined cell types.
print(f"\nDisplaying heatmap of top 10 markers per cell type from '{annotation_key}':")
sc.pl.rank_genes_groups_heatmap(adata, n_genes=10, groupby=annotation_key, show=True)

# --- How to Use This Output for Validation ---
#
# The goal now is to confirm that your new, cleaner clusters have the
# expected data-driven markers.
#
# 1. Check the major cell types again (Hepatocyte, Kupffer Cell, etc.). The
#    top DEGs should still be biologically consistent with these labels.
#
# 2. Most importantly, inspect the cell types that were previously "mixed". For
#    example, if you now have a pure 'Stellate Cell' cluster, are its top
#    DEGs canonical stellate cell markers like 'Acta2', 'Dcn', 'Lrat',
#    'Col1a1', etc.?
#
# 3. If the DEGs strongly align with the new, resolved cell type labels,
#    you can be highly confident that your batch correction was successful
#    and your final annotation is robust.
#
# This step completes the annotation workflow for the batch-corrected data.
