import scanpy as sc
import pandas as pd

# --- Differentially-Expressed Genes as Markers ---
# This script uses the data-driven `rank_genes_groups` function to find the
# top genes that define each of our manually annotated cell types.
# The goal is to VALIDATE our previous manual annotation.

# Setup Scanpy settings
sc.settings.verbosity = 3
sc.settings.set_figure_params(dpi=80, facecolor='white', frameon=False)

# 1. Load the AnnData object with your manual cell_type annotations
# This file should be the output of your previous script.
adata = sc.read_h5ad('Liver_facs_uncorrected_annotated.h5ad') # Make sure this is the correct saved file

# 2. Calculate differentially expressed genes for each annotated cell type
# This function will compare each cell type against all other cells to find
# genes that are uniquely upregulated. We use the 't-test' method here for speed.
# Note: As the tutorial mentions, the p-values will be tiny; we are most
# interested in the RANKING of the genes (the 'names' column) and the
# log-fold-change scores.
sc.tl.rank_genes_groups(adata, groupby='cell_type', method='t-test')

# 3. Visualize the top marker genes for each cell type
# This plot shows a bar chart of the top genes ranked by their score (e.g., t-statistic).
# It's the best way to get a quick overview.
print("Displaying top marker genes for each annotated cell type:")
sc.pl.rank_genes_groups(adata, n_genes=20, sharey=False, show=True)

# 4. Create a heatmap of the top marker genes
# A heatmap can give a more detailed view of the expression patterns of the
# top defining genes across all cell types.
print("\nDisplaying heatmap of top 10 markers per cell type:")
sc.pl.rank_genes_groups_heatmap(adata, n_genes=10, groupby="cell_type", show=True)

# --- How to Use This Output for Validation ---
#
# 1. Look at the bar chart for the 'Hepatocyte' group. Are the top genes
#    'Alb', 'Apoa1', 'G6pc', etc.? If YES, your annotation is strongly supported.
#
# 2. Look at the 'Kupffer Cell' group. Are the top genes 'Clec4f', 'Cd68', etc.?
#    If YES, your annotation is supported.
#
# 3. Pay special attention to your 'Hepatocyte/Stellate_mix' cluster. What are
#    its top genes? This will give you clues about its true identity or state.
#    You might see a mix of markers, or perhaps a completely different set of
#    genes related to a specific biological process like stress or metabolism.
#
# This step completes the initial annotation loop: you made a hypothesis with
# known markers, and now you have used the data itself to check that hypothesis.
