import scanpy as sc
import scanpy.external as sce

# Load filtered, normalized, HVG data
adata = sc.read_h5ad("Liver_facs_filtered_normalized.h5ad")
adata.var_names_make_unique()
adata.obs_names_make_unique()

# --- UMAP before batch correction ---
sc.pp.neighbors(adata, n_neighbors=15, n_pcs=30)  # uses stored PCA
sc.tl.umap(adata)
sc.pl.umap(adata, color='batch', title="UMAP before batch correction")

# --- Batch correction with BBKNN ---
sce.pp.bbknn(adata, batch_key='batch')

# --- UMAP after batch correction ---
sc.tl.umap(adata)
sc.pl.umap(adata, color='batch', title="UMAP after batch correction")

# Save the batch-corrected dataset
adata.write("Liver_facs_batch_corrected.h5ad")

