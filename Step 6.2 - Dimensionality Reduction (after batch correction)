import scanpy as sc

# Load the batch-corrected data
adata = sc.read_h5ad("Liver_facs_batch_corrected.h5ad")
adata.var_names_make_unique()
adata.obs_names_make_unique()

# Subset to highly variable genes for PCA
adata_hvg = adata[:, adata.var['highly_variable']].copy()

# Scale the data (zero mean, unit variance)
sc.pp.scale(adata_hvg, max_value=10)

# Run PCA
sc.tl.pca(adata_hvg, n_comps=50, svd_solver='arpack')

# Inspect variance explained by PCs
sc.pl.pca_variance_ratio(adata_hvg, n_pcs=50, log=True, show=True)

# PCA scatter plots colored by batch
sc.pl.pca(
    adata_hvg,
    color=["batch", "batch"],
    dimensions=[(0, 1), (2, 3)],
    ncols=2,
    size=20
)
