import scanpy as sc

# Load the filtered, normalized, HVG-annotated data
adata = sc.read_h5ad("Liver_facs_filtered_normalized.h5ad")
adata.var_names_make_unique()
adata.obs_names_make_unique()

# Subset to highly variable genes for PCA
adata_hvg = adata[:, adata.var['highly_variable']].copy()

# Scale the data (zero mean, unit variance)
sc.pp.scale(adata_hvg, max_value=10)

# Run PCA
sc.tl.pca(adata_hvg, n_comps=50, svd_solver='arpack')

# Inspect variance explained by PCs
sc.pl.pca_variance_ratio(adata_hvg, n_pcs=50, log=True, show=True)

# PCA scatter plots colored by batch
sc.pl.pca(
    adata,
    color=["batch", "batch"],  # or 'sample' if preferred
    dimensions=[(0, 1), (2, 3)],
    ncols=2,
    size=20
)

# Save the PCA-processed dataset (HVGs only used in PCA, full data still in original adata)
adata_hvg.write("Liver_facs_PCA_no_batch_correction.h5ad")

print("PCA done. Dataset shape:", adata_hvg.shape)

