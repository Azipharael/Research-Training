import scanpy as sc

# Load the HVG-only dataset from feature selection step
adata = sc.read_h5ad("Liver_facs_filtered_normalized_HVG.h5ad")
adata.var_names_make_unique()
adata.obs_names_make_unique()

# Scale the data (zero mean, unit variance)
sc.pp.scale(adata, max_value=10)

# Run PCA
sc.tl.pca(adata, n_comps=50, svd_solver='arpack')

# Inspect variance explained by PCs
sc.pl.pca_variance_ratio(adata, n_pcs=50, log=True, show=True)

# PCA scatter plots colored by batch
sc.pl.pca(
    adata,
    color=["batch"],  # "sample" is another option
    dimensions=[(0, 1), (2, 3)],
    ncols=2,
    size=20
)

# Save the PCA-processed dataset
adata.write("Liver_facs_PCA_no_batch_correction.h5ad")

print("PCA done. Dataset shape:", adata.shape)

